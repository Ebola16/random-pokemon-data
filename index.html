<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Random Image Redirect</title>
  <script>
    function safeRegex(pattern) {
        // Reject nested quantifiers like (a+)+ or (a*)+
        if (/\((?:[^()]*?[\*\+\?][^()]*?)\)[\*\+\?]/.test(pattern)) {
            return false;
        }

        // Reject nested groups with alternations and quantifiers like (a|b)+
        // This looks for groups that contain a '|' and are followed by quantifiers
        if (/\((?:[^()]*\|[^()]*)+\)[\*\+\?]/.test(pattern)) {
            return false;
        }

        // Reject nested lookaheads with quantifiers like (?=a+)+
        // Matches lookahead groups with quantifiers applied to them
        if (/\(\?[:=!][^()]*[\*\+\?][^()]*\)[\*\+\?]/.test(pattern)) {
            return false;
        }

        // Reject nested capturing groups with quantifiers: e.g. ((abc)+)+
        // Matches any group that contains another group with quantifier and itself quantified
        if (/\((?:[^()]*\([^()]*[\*\+\?][^()]*\)[^()]*)\)[\*\+\?]/.test(pattern)) {
            return false;
        }

        return true;
    }

    async function redirectToRandomImage() {
      try {
        const response = await fetch('data/images.json');
        const images = await response.json();

        const params = new URLSearchParams(window.location.search);
        const regexString = params.get("regex") || ".*";

        if (regexString.length > 256) {
          document.body.textContent = "256 character regex limit exceeded.";
          return;
        }

        if (!safeRegex(regexString)) {
          document.body.textContent = "Unsafe regex pattern.";
          return;
        }

        const worker = new Worker('js/worker.js');
        const timeout = 100; // ms

        const timeoutId = setTimeout(() => {
          worker.terminate();
          document.body.textContent = "Regex took too long to process.";
        }, timeout);

        worker.onmessage = (e) => {
          clearTimeout(timeoutId);
          if (!e.data.success) {
            document.body.textContent = e.data.error;
            return;
          }

          const filtered = e.data.filtered;
          if (filtered.length === 0) {
            document.body.textContent = "No matching images found.";
            return;
          }

          const randomImage = filtered[Math.floor(Math.random() * filtered.length)];
          const fullPath = encodeURI(`/images/${randomImage}`);
          window.location.href = fullPath;
        };

        worker.postMessage({ images, regexString });
      } catch (err) {
        console.error(err);
        document.body.textContent = "Failed to load images.";
      }
    }

    window.onload = redirectToRandomImage;
  </script>
</head>
<body>
  <p>Redirecting to a random image...</p>
</body>
</html>
